{% extends 'base.html' %}

{% block content %}
        <div>Event</div>
        {{ event_data }}
        <!--
            СИТУАЦИЯ 1 - когда создаешь новый ИВЕНТ

            Если переменная event_data пустая, то создаем форму
                "name": для строкового значения,
                "type": целочисленное значение, (заменить на слова. 1 - Атака, 2 - Защита),
                "date": выбор даты и выбор времени,
                "enemy": Текстовое поле. Когда в него вводишь символы (не менее 3-х), то с задержкой в 2 секунды отправляется запрос
                  url = "http://127.0.0.1:8000/api/clans"
                  params = {
                          "clan_name": введенные символы
                  }
                  После того как пользователь выбрал клан - рендеришь его гифку и название
            После формы зарендерить кнопку "СОЗДАТЬ ИВЕНТ"
            По нажатию на кнопку отправляется запрос
              url: http://127.0.0.1:8000/api/events/
              type: POST
              body: {
                  "voevoda_id": request.session.voevoda_id,
                  "date": значение переменной date, которую ввел пользователь преобразованную в timestampt
                  "enemy": id enemy который выбрал пользователь
              }
              ОТВЕТ:
                  {
                    "id": целочисленное значение, (рендерить не нужно)
                    "name": строковое значение, (отрендерить и зашить href = {% url 'event' %}?event_id=[ID из поля выше]
                    "type": целочисленное значение, (заменить на слова. 1 - Атака, 2 - Защита)
                    "date": целочисленное значение в timestampt, (привести к виду (dd.mm.yyyy hh:mm)
                    "voevoda_id": целочисленное значение, (рендерить не нужно)
                    "enemy": {
                      "id": целочисленное значение (рендерить не нужно)
                      "name: строковое значение (рендерим)
                      "label": url гифка (нужно зарендерить + спрянать под нее ссылку href = https://www.heroeswm.ru/pl_info.php?id=[ID из поля выше])
                    },
                    "state": целочисленное значение (1 - "Первоначальный сбор", 2 - "Выбор бойцов", 3 - "Идет бой", 4 - "Завершен")
                }
                Далее необходимо произвести редирект на url {% url 'event' %}?event_id=[ID который пришел в ответ на POST запрос]

            СИТУАЦИЯ 2 (когда ивент создан и state = 1)
                url: http://127.0.0.1:8000/api/persons/
                type: GET
                params: voevoda_id=request.session.voevoda_id

                ОТВЕТ будет огромный список JSONов, Показать только тех у кого поле activity == true:
                      data: [
                        {
                                "id": целочисленное значение,
                                "role": целочисленное значение  (1, "Воевода"),
                                                                (2, "Помощник воеводы"),
                                                                (100, "Игрок"),  Нужно при рендеринге преобразовать число в строку
                                "telegram_id": строковое значение,
                                "telegram_username": строковое значение,
                                "voevoda_id": целочисленное значение, - Рендерин не нужно
                                "activity": bool значение, (заменить на галочку или крестик)
                                "comment": строковое значение,
                                "stats": {
                                        "id": целочисленное значение,
                                        "name": строковое значение, спрятать ссылку https://www.heroeswm.ru/pl_info.php?id=[ID из поля выше],
                                        "level": целочисленное значение,
                                        "clan": целочисленное значение, - его отображать не нужно
                                        "umka_knight": целочисленное значение,
                                        "umka_necro": целочисленное значение,
                                        "umka_mag": целочисленное значение,
                                        "umka_elf": целочисленное значение,
                                        "umka_barbar": целочисленное значение,
                                        "umka_black_elf": целочисленное значение,
                                        "umka_demon": целочисленное значение,
                                        "umka_dwarf": целочисленное значение,
                                        "umka_step_barb": целочисленное значение,
                                        "umka_pharaon": целочисленное значение,
                                        "gild_hunt": целочисленное значение,
                                        "gild_work": целочисленное значение,
                                        "gild_card": целочисленное значение,
                                        "gild_thief": целочисленное значение,
                                        "gild_ranger": целочисленное значение,
                                        "gild_mers": целочисленное значение,
                                        "gild_tactic": целочисленное значение,
                                        "gild_gard": целочисленное значение,
                                        "gild_seekers": целочисленное значение,
                                        "gild_leader": целочисленное значение,
                                        "gild_blacksmith": целочисленное значение,
                                        "gild_gunsmith": целочисленное значение
                                },
                                "presets": [
                                        {
                                          "id": целочисленное значение, - рендерить не нужно
                                          "voevoda_id": целочисленное значение, - рендерить не нужно
                                          "fraction": целочисленное значение, (0, "Рыцарь"),
                                                                              (1, "Некромант"),
                                                                              (2, "Маг"),
                                                                              (3, "Эльф"),
                                                                              (4, "Варвар"),
                                                                              (5, "Темный эльф"),
                                                                              (6, "Демон"),
                                                                              (7, "Гном"),
                                                                              (8, "Степной варвар"),
                                                                              (9, "Фараон"), - нужно из числового значения отрендерить строку
                                          "name": строковое значение,  под название спрятать переход на url ниже, где preset_id = ID выше
                                          "description": строковое значение (может быть длинным)
                                          play_preset: bool значение, ставим галочку или крестик
                                ]

                ЕСЛИ type ивента  == 1 (атака), то отображаем всех игроков
                Если type ивента == 2 (защита), то отображаем только игроков у которых stats.clan == request.session.clan_id

                НАПРОТИВ каждого игрока ставим поле, в котором можно поставить галочку (ОТправить приглашение)

                СНИЗУ ДЕЛАЕМ КНОПКУ "ОТПРАВИТЬ ПРИГЛАШЕНИЕ"
                По нажатию на кнопку собираются все значения с галочками и в цикле отправляются запросы

                url: http://127.0.0.1:8000/api/invites/
                type: POST
                body: {
                    "event_id": ID ивента выше
                    "person_id": идентификатор персонажа (напротив которого поставили галочку)
                }

                Далее отправляем запрос
                url: http://127.0.0.1:8000/api/events/
                type: PATCH
                body: {
                    "event_id": ID ивента,
                    "state": 2
                }

                Далее необходимо произвести редирект на url {% url 'event' %}?event_id=[ID ивента берем выше]

            СИТУАЦИЯ 3 - state == 2
                Рендерим информацию об ивенте

                Выгружаем игроков которым было направлено приглашение

                Делаем запрос:
                url: http://127.0.0.1:8000/api/invites/
                type: GET
                params = {
                    "event_id": ID ивента
                }

                ОТВЕТ JSON со списком
                [
                  {
                    "id": целочисленное значение (рендерить не нужно),
                    "date": целочисленное значение (рендерить не нужно),
                    "event_id": целочисленное значение (рендерить не нужно),
                    "person_id": Данные о перснаже как в ситуации №3,
                    "state": целочисленное значени (заменить на 1 - "Отправлено", 2 - "Принято", 3 - "Отказ", 4 - "Выбран на бой")
                  }
                ]

                Далее выгружаем всех игроков соперника

                Делаем запрос
                url: http://127.0.0.1:8000/api/players/
                type: GET
                params: clan_id={{ clan_id }}

                ОТВЕТ:
                data: [
                        {
                            "id": целочисленное значение,
                            "name": строковое значение, спрятать ссылку https://www.heroeswm.ru/pl_info.php?id=[ID из поля выше],
                            "level": целочисленное значение,
                            "clan": целочисленное значение, - его отображать не нужно
                            "umka_knight": целочисленное значение,
                            "umka_necro": целочисленное значение,
                            "umka_mag": целочисленное значение,
                            "umka_elf": целочисленное значение,
                            "umka_barbar": целочисленное значение,
                            "umka_black_elf": целочисленное значение,
                            "umka_demon": целочисленное значение,
                            "umka_dwarf": целочисленное значение,
                            "umka_step_barb": целочисленное значение,
                            "umka_pharaon": целочисленное значение,
                            "gild_hunt": целочисленное значение,
                            "gild_work": целочисленное значение,
                            "gild_card": целочисленное значение,
                            "gild_thief": целочисленное значение,
                            "gild_ranger": целочисленное значение,
                            "gild_mers": целочисленное значение,
                            "gild_tactic": целочисленное значение,
                            "gild_gard": целочисленное значение,
                            "gild_seekers": целочисленное значение,
                            "gild_leader": целочисленное значение,
                            "gild_blacksmith": целочисленное значение,
                            "gild_gunsmith": целочисленное значение
                        }
                    ]

             Если тип ивента == 2 (защита), то дополнительно
             делаем запросы
             1) url: http://127.0.0.1:8000/api/clans/
                type: GET
                params: clan_id=enemy.id

                ОТВЕТ:
                data: {
                        "id": Целочисленное значение,
                        "name": Строковое значение,
                        "label": url адрес гифки, которую нужно отрендерить + под гифку спрятать ссылку https://www.heroeswm.ru/clan_info.php?id=[ID из поля выше],
                        "alliance": null или {
                                "id": Целочисленное значение,
                                "name": Строковое значение,
                                "label": url адрес гифки, которую нужно отрендерить + под гифку спрятать ссылку https://www.heroeswm.ru/clan_info.php?id=[ID из поля выше]
                         }
                }

               Если поле alliance не равно нулю, то делаем запрос

               url: http://127.0.0.1:8000/api/players/
              type: GET
              params: clan_id=alliance.id

            БОИ ПРОХОДЯТ 2 на 2

            Создаем по 2 поля для стороны атаки и защиты

            Напротив каждого из полей сделать еще одно с выбором уровня. Как только выбираем уровень,
            проводишь фильтр всех игроков стороны по полю "level" и даешь пользователю выбрать игрока


            РЕНДЕРИМ КНОПКУ "ПРИГЛАСИТЬ НА БОЙ"
            После того, как пользователь выбрал игроков своей стороны в полях выше - нажимаем на кнопку
            и по выбранным игрокам своей стороны отправляются запросы

            Делаем запрос:
                url: http://127.0.0.1:8000/api/invites/
                type: POST
                params = {
                    "event_id": ID ивента,
                    "state": 4
                }

            Обновляем ивент
              url: http://127.0.0.1:8000/api/events/
              type: PATCH
              body: {
                  "event_id": ID ивента,
                  "state": 3
              }

             Далее необходимо произвести редирект на url {% url 'event' %}?event_id=[ID ивента берем выше]

         СИТУАЦИЯ 4 - state == 3 (Идент бой)

         Отображаем информацию об ИВЕНТЕ

          Делаем запрос
          url: http://127.0.0.1:8000/api/invites/
          type: GET
          params = {
              "event_id": ID ивента,
              "state__in": 4
          }

          ВНИЗУ ЕСТЬ КНОПКА "ЗАВЕРШИТЬ"

          Понажатию на кнопку отправляем запрос
          url: http://127.0.0.1:8000/api/events/
          type: PATCH
          body: {
              "event_id": ID ивента,
              "state": 4
          }

          И производим redirect
          "{% url 'fight' %}?event_id=[ID ивента]"

        -->
{% endblock %}